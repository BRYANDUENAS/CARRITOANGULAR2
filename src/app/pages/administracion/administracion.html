<div class="container">
    <h2>Administración de Productos</h2>

    <div class="mb-3">
        <button class="btn btn-primary" (click)="abrirModalCrear()">
            <i class="bi bi-plus-circle"></i> Crear Nuevo Producto
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Imagen</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Categoría</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @for (producto of productosTienda; track producto.id) {
                <tr>
                    <td>{{ producto.id }}</td>
                    <td>
                        <img [src]="producto.imagen" [alt]="producto.nombre" class="product-image" width="50"
                            height="50">
                    </td>
                    <td>{{ producto.nombre }}</td>
                    <td class="descripcion-cell">{{ producto.descripcion }}</td>
                    <td>{{ producto.precio | currency:'USD' }}</td>
                    <td>
                        <span class="badge bg-secondary">{{ producto.categoria }}</span>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-warning btn-sm" title="Editar" (click)="abrirModalEditar(producto)">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                            <button class="btn btn-danger btn-sm" title="Eliminar"
                                (click)="eliminarProducto(producto.id)">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </div>
                    </td>
                </tr>
                } @empty {
                <tr>
                    <td colspan="7" class="text-center">No hay productos disponibles</td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Modal para crear/editar producto -->
    @if (mostrarModal) {
    <div class="modal-backdrop show" (click)="cerrarModal()"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        {{ modoEdicion ? 'Editar Producto' : 'Crear Nuevo Producto' }}
                    </h5>
                    <button type="button" class="btn-close" (click)="cerrarModal()"></button>
                </div>
                <div class="modal-body">
                    <form (ngSubmit)="guardarProducto()" #productoForm="ngForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">Nombre *</label>
                                    <input type="text" class="form-control" id="nombre" name="nombre"
                                        [(ngModel)]="productoSeleccionado.nombre" required #nombre="ngModel">
                                    @if (nombre.invalid && nombre.touched) {
                                    <div class="text-danger">El nombre es requerido</div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label for="precio" class="form-label">Precio *</label>
                                    <input type="number" class="form-control" id="precio" name="precio"
                                        [(ngModel)]="productoSeleccionado.precio" required min="0" step="0.01"
                                        #precio="ngModel">
                                    @if (precio.invalid && precio.touched) {
                                    <div class="text-danger">El precio es requerido y debe ser válido</div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label for="categoria" class="form-label">Categoría *</label>
                                    <select class="form-select" id="categoria" name="categoria"
                                        [(ngModel)]="productoSeleccionado.categoria" required #categoria="ngModel">
                                        <option value="">Seleccionar categoría</option>
                                        @for (cat of categorias; track cat) {
                                        <option [value]="cat">{{ cat }}</option>
                                        }
                                    </select>
                                    @if (categoria.invalid && categoria.touched) {
                                    <div class="text-danger">La categoría es requerida</div>
                                    }
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="imagen" class="form-label">URL de la Imagen *</label>
                                    <input type="url" class="form-control" id="imagen" name="imagen"
                                        [(ngModel)]="productoSeleccionado.imagen" required #imagen="ngModel">
                                    @if (imagen.invalid && imagen.touched) {
                                    <div class="text-danger">La URL de la imagen es requerida</div>
                                    }
                                    @if (productoSeleccionado.imagen) {
                                    <div class="mt-2">
                                        <img [src]="productoSeleccionado.imagen" alt="Vista previa"
                                            class="img-thumbnail" style="max-height: 100px;"
                                            onerror="this.style.display='none'">
                                    </div>
                                    }
                                </div>

                                <div class="mb-3">
                                    <label for="descripcion" class="form-label">Descripción *</label>
                                    <textarea class="form-control" id="descripcion" name="descripcion"
                                        [(ngModel)]="productoSeleccionado.descripcion" required rows="4"
                                        #descripcion="ngModel"></textarea>
                                    @if (descripcion.invalid && descripcion.touched) {
                                    <div class="text-danger">La descripción es requerida</div>
                                    }
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" (click)="guardarProducto()"
                        [disabled]="!productoForm.form.valid">
                        {{ modoEdicion ? 'Actualizar' : 'Crear' }} Producto
                    </button>
                </div>
            </div>
        </div>
    </div>
    }
</div>